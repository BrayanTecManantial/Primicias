<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sede - Control de Inventario</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --bg: #f8fafc; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        h2, h3 { text-align: center; color: #1e293b; margin-top: 0; }
        .hidden { display: none; }
        .info-badge { background: #e2e8f0; padding: 10px; border-radius: 8px; font-weight: bold; text-align: center; margin-bottom: 20px; font-size: 0.9em; }
        label { display: block; margin: 12px 0 5px; font-weight: 600; color: #475569; }
        select, input, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; margin-top: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-red { background: var(--danger); color: white; }
        .btn-gray { background: #64748b; color: white; }
        .loader { text-align: center; padding: 20px; color: #64748b; }
        .reg-nueva-persona { background: #f1f5f9; padding: 15px; border-radius: 8px; border: 1px dashed #cbd5e1; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container" id="app">
    <div id="loading" class="loader">Cargando sistema...</div>

    <div id="loginScreen" class="hidden">
        <h2>‚ö†Ô∏è Acceso no detectado</h2>
        <p>Por favor, escanea el c√≥digo QR de tu sede para ingresar.</p>
    </div>

    <div id="menuScreen" class="hidden">
        <div id="infoSede" class="info-badge"></div>
        <button class="btn-blue" onclick="navegar('ingresoScreen')">üì• REGISTRAR INGRESO</button>
        <button class="btn-green" onclick="navegar('salidaScreen')">üì§ REGISTRAR SALIDA</button>
        <button class="btn-red" onclick="cerrarSesion()">Cerrar Sede</button>
    </div>

    <div id="ingresoScreen" class="hidden">
        <h3>Ingreso de Material</h3>
        <label>Clasificaci√≥n:</label>
        <select id="catIn" onchange="cargarSubproductos('in')">
            <option value="">-- Seleccionar --</option>
            <option value="Alimentos">Alimentos</option>
            <option value="Ropa y Textiles">Ropa y Textiles</option>
            <option value="Medicamentos y Salud">Medicamentos y Salud</option>
            <option value="Art√≠culos de Higiene y Limpieza">Art√≠culos de Higiene y Limpieza</option>
            <option value="√ötiles Escolares">√ötiles Escolares</option>
            <option value="Herramientas">Herramientas</option>
            <option value="Tecnolog√≠a y Electr√≥nica">Tecnolog√≠a y Electr√≥nica</option>
            <option value="Miscel√°neos/Otros">Miscel√°neos/Otros</option>
        </select>

        <label>Producto:</label>
        <select id="prodIn"><option value="">-- Elige clasificaci√≥n --</option></select>

        <label>Cantidad:</label>
        <input type="number" id="cantIn" value="1" min="1">

        <label>Observaciones:</label>
        <textarea id="obsIn" rows="2"></textarea>

        <button class="btn-blue" onclick="enviarIngreso()">Guardar Entrada</button>
        <button class="btn-gray" onclick="navegar('menuScreen')">Volver</button>
    </div>

    <div id="salidaScreen" class="hidden">
        <h3>Salida / Entrega</h3>
        <label>C√©dula (CC):</label>
        <input type="number" id="ccSearch" placeholder="Escribe la CC">
        <button class="btn-blue" onclick="buscarPersona()">üîç Buscar Persona</button>

        <div id="zonaRegistroSalida" class="hidden">
            <div id="datosPersonaNueva" class="reg-nueva-persona hidden">
                <p style="margin:0 0 10px; color:var(--danger); font-weight:bold;">Persona no registrada. Completa:</p>
                <label>Nombre Completo:</label>
                <input type="text" id="nombreOut">
                <label>Rol / Cargo:</label>
                <select id="rolOut">
                    <option value="Colaborador">Colaborador</option>
                    <option value="Area">Area</option>
                    <option value="Sup General">Sup General</option>
                    <option value="Sup Auxiliar">Sup Auxiliar</option>
                    <option value="L√≠der">L√≠der</option>
                    <option value="Hermano mayor">Hermano mayor</option>
                    <option value="Coordinador El Camino">Coordinador El Camino</option>
                    <option value="Maestro">Maestro</option>
                    <option value="Diaconado">Diaconado</option>
                </select>
            </div>

            <div id="infoPersonaExistente" class="info-badge hidden" style="margin-top:15px; background:#f0fdf4;"></div>

            <label>Clasificaci√≥n a entregar:</label>
            <select id="catOut" onchange="cargarSubproductos('out')">
                <option value="">-- Seleccionar --</option>
                <option value="Alimentos">Alimentos</option>
                <option value="Ropa y Textiles">Ropa y Textiles</option>
                <option value="Medicamentos y Salud">Medicamentos y Salud</option>
                <option value="Art√≠culos de Higiene y Limpieza">Art√≠culos de Higiene y Limpieza</option>
                <option value="√ötiles Escolares">√ötiles Escolares</option>
                <option value="Herramientas">Herramientas</option>
                <option value="Tecnolog√≠a y Electr√≥nica">Tecnolog√≠a y Electr√≥nica</option>
                <option value="Miscel√°neos/Otros">Miscel√°neos/Otros</option>
            </select>

            <label>Producto:</label>
            <select id="prodOut"><option value="">-- Elige clasificaci√≥n --</option></select>

            <label>Cantidad:</label>
            <input type="number" id="cantOut" value="1">

            <label>Estado del material:</label>
            <select id="estadoOut">
                <option value="Nuevo">Nuevo / Sellado</option>
                <option value="Buen Estado">Usado (Buen Estado)</option>
                <option value="Novedad">Con Novedad / Da√±o</option>
            </select>

            <button class="btn-green" onclick="enviarSalida()">Confirmar Salida</button>
        </div>
        <button class="btn-gray" onclick="navegar('menuScreen')">Volver</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxayHseCRZ2NYM2mcU5zXwZaucSOfz4gDnBo9NPSJXVZKNRpZxw22aT1rogXx4t_f_V/exec"; 

    const CATALOGO = {
        "Alimentos": ["Comida no perecedera (enlatados, arroz...)", "Bebidas (agua, jugos...)", "Productos perecederos (pan, frutas...)"],
        "Ropa y Textiles": ["Ropa adultos/j√≥venes", "Ropa ni√±os/beb√©s", "Mantas, cobijas y s√°banas", "Calzado y accesorios"],
        "Medicamentos y Salud": ["Medicamentos venta libre", "Insumos m√©dicos (gasas, alcohol...)"],
        "Art√≠culos de Higiene y Limpieza": ["Higiene personal", "Limpieza hogar"],
        "√ötiles Escolares": ["Mochilas y estuches", "Cuadernos y l√°pices", "Libros", "Material de arte"],
        "Herramientas": ["Herramientas manuales", "Herramientas el√©ctricas", "Materiales construcci√≥n", "Repuestos/Clavos"],
        "Tecnolog√≠a y Electr√≥nica": ["Tel√©fonos/Tablets/Laptops", "Cargadores/Cables", "Peque√±os electrodom√©sticos"],
        "Miscel√°neos/Otros": ["Accesorios (perfumes, cremas)", "Juguetes/Adornos/Varios"]
    };

    let datosSede = null;
    let personaEncontrada = false;

    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        const clave = params.get('clave');
        const local = localStorage.getItem('sedeData');

        if (clave) validar(clave);
        else if (local) { datosSede = JSON.parse(local); iniciar(); }
        else mostrar('loginScreen');
    };

    function validar(c) {
        fetch(`${SCRIPT_URL}?accion=validar&clave=${c}`)
            .then(r => r.json()).then(d => {
                if(d.status === "success") {
                    datosSede = d;
                    localStorage.setItem('sedeData', JSON.stringify(d));
                    window.history.replaceState({}, '', window.location.pathname);
                    iniciar();
                } else { mostrar('loginScreen'); }
            });
    }

    function iniciar() {
        document.getElementById('infoSede').innerText = `üìç ${datosSede.sede}`;
        mostrar('menuScreen');
    }

    function mostrar(id) {
        ['loading','loginScreen','menuScreen','ingresoScreen','salidaScreen'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function navegar(id) { mostrar(id); }

    function cargarSubproductos(tipo) {
        const cat = document.getElementById(tipo === 'in' ? 'catIn' : 'catOut').value;
        const pSel = document.getElementById(tipo === 'in' ? 'prodIn' : 'prodOut');
        pSel.innerHTML = '<option value="">-- Selecciona Producto --</option>';
        if(CATALOGO[cat]) CATALOGO[cat].forEach(p => pSel.innerHTML += `<option value="${p}">${p}</option>`);
    }

    function buscarPersona() {
        const cc = document.getElementById('ccSearch').value;
        if(!cc) return alert("Escribe una CC");
        
        fetch(`${SCRIPT_URL}?accion=buscar&cc=${cc}`)
            .then(r => r.json()).then(d => {
                document.getElementById('zonaRegistroSalida').classList.remove('hidden');
                if(d.status === "success") {
                    personaEncontrada = true;
                    document.getElementById('datosPersonaNueva').classList.add('hidden');
                    const info = document.getElementById('infoPersonaExistente');
                    info.classList.remove('hidden');
                    info.innerHTML = `üë§ ${d.nombre}<br><small>Rol: ${d.rol} | √öltimo: ${d.ultimoProducto}</small>`;
                } else {
                    personaEncontrada = false;
                    document.getElementById('datosPersonaNueva').classList.remove('hidden');
                    document.getElementById('infoPersonaExistente').classList.add('hidden');
                }
            });
    }

    function enviarIngreso() {
        const btn = event.target; btn.disabled = true;
        const data = {
            tipo: 'ingreso',
            sede: datosSede.sede,
            categoria: document.getElementById('catIn').value,
            producto: document.getElementById('prodIn').value,
            cantidad: document.getElementById('cantIn').value,
            observaciones: document.getElementById('obsIn').value
        };
        if(!data.producto) return (alert("Elige producto"), btn.disabled=false);
        postData(data);
    }

    function enviarSalida() {
        const btn = event.target; btn.disabled = true;
        const data = {
            tipo: 'salida',
            sede: datosSede.sede,
            cc: document.getElementById('ccSearch').value,
            categoria: document.getElementById('catOut').value,
            producto: document.getElementById('prodOut').value,
            cantidad: document.getElementById('cantOut').value,
            estado: document.getElementById('estadoOut').value,
            observaciones: ""
        };

        if(!personaEncontrada) {
            data.nombre = document.getElementById('nombreOut').value;
            data.rol = document.getElementById('rolOut').value;
            if(!data.nombre) return (alert("Escribe el nombre"), btn.disabled=false);
        }

        if(!data.producto) return (alert("Elige producto"), btn.disabled=false);
        postData(data);
    }

    function postData(d) {
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(d) })
            .then(r => r.json()).then(res => {
                if(res.status === "success") { alert("‚úÖ Guardado"); location.reload(); }
            }).catch(e => alert("Error al guardar"));
    }

    function cerrarSesion() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
