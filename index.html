<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primicias - Control de Sede</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5; --secondary: #64748b;
            --alimentos: #f59e0b; --ropa: #ec4899; --salud: #ef4444;
            --higiene: #06b6d4; --utiles: #8b5cf6; --herramientas: #10b981;
            --tech: #3b82f6; --otros: #78350f; --bg: #f1f5f9;
        }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 0; }
        .header { background: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; }
        .hidden { display: none; }

        /* Estilo de Tarjetas de Categor√≠a */
        .grid-categories { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .card-cat { 
            background: white; border-radius: 15px; padding: 20px; text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-bottom: 5px solid transparent;
            transition: transform 0.2s; cursor: pointer;
        }
        .card-cat:active { transform: scale(0.95); }
        .card-cat i { font-size: 30px; display: block; margin-bottom: 10px; }
        .cat-alimentos { border-color: var(--alimentos); }
        .cat-ropa { border-color: var(--ropa); }
        .cat-salud { border-color: var(--salud); }
        .cat-higiene { border-color: var(--higiene); }
        .cat-utiles { border-color: var(--utiles); }
        .cat-herramientas { border-color: var(--herramientas); }
        .cat-tech { border-color: var(--tech); }
        .cat-otros { border-color: var(--otros); }

        /* Formularios y Botones */
        .form-group { background: white; padding: 20px; border-radius: 15px; margin-top: 20px; }
        label { font-weight: 600; color: #334155; display: block; margin-bottom: 10px; }
        select, input, textarea { 
            width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; 
            font-size: 16px; margin-bottom: 15px; box-sizing: border-box;
        }
        .btn { 
            width: 100%; padding: 15px; border: none; border-radius: 10px; 
            font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 10px;
        }
        .btn-main { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-success { background: var(--herramientas); color: white; }
        
        .badge-sede { background: #e0e7ff; color: #4338ca; padding: 5px 15px; border-radius: 20px; font-size: 12px; display: inline-block; }
    </style>
</head>
<body>

<div class="header">
    <div id="nombreSede" class="badge-sede">Cargando Sede...</div>
    <h2 id="tituloPantalla" style="margin: 10px 0 0;">Gesti√≥n de Primicias</h2>
</div>

<div class="container">
    <div id="loading" style="text-align:center; margin-top:50px;">‚è≥ Validando acceso...</div>

    <div id="menuScreen" class="hidden">
        <p style="text-align:center; color:#64748b;">¬øQu√© acci√≥n deseas realizar hoy?</p>
        <button class="btn btn-main" onclick="irA('ingresoCat')">üì• Registrar Donaci√≥n (Ingreso)</button>
        <button class="btn btn-outline" onclick="irA('salidaPersona')">üì§ Entrega / Salida</button>
        <button class="btn btn-outline" style="border-color:#ef4444; color:#ef4444; margin-top:30px;" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>

    <div id="ingresoCat" class="hidden">
        <h3 style="text-align:center;">Selecciona la Clasificaci√≥n</h3>
        <div class="grid-categories">
            <div class="card-cat cat-alimentos" onclick="seleccionarCat('Alimentos', 'üì•')"><i>üçé</i>Alimentos</div>
            <div class="card-cat cat-ropa" onclick="seleccionarCat('Ropa y Textiles', 'üëï')"><i>üëï</i>Ropa</div>
            <div class="card-cat cat-salud" onclick="seleccionarCat('Medicamentos y Salud', 'üíä')"><i>üíä</i>Salud</div>
            <div class="card-cat cat-higiene" onclick="seleccionarCat('Art√≠culos de Higiene', 'üßº')"><i>üßº</i>Higiene</div>
            <div class="card-cat cat-utiles" onclick="seleccionarCat('√ötiles Escolares', 'üìö')"><i>üìö</i>√ötiles</div>
            <div class="card-cat cat-herramientas" onclick="seleccionarCat('Herramientas', 'üõ†Ô∏è')"><i>üõ†Ô∏è</i>Herramientas</div>
            <div class="card-cat cat-tech" onclick="seleccionarCat('Tecnolog√≠a', 'üíª')"><i>üíª</i>Tecnolog√≠a</div>
            <div class="card-cat cat-otros" onclick="seleccionarCat('Miscel√°neos/Otros', 'üì¶')"><i>üì¶</i>Otros</div>
        </div>
        <button class="btn btn-outline" style="margin-top:20px;" onclick="irA('menuScreen')">Volver</button>
    </div>

    <div id="ingresoDetalle" class="hidden">
        <div class="form-group">
            <h3 id="catElegida" style="margin-top:0;"></h3>
            <label>Producto:</label>
            <select id="prodIn"></select>
            <label>Cantidad:</label>
            <input type="number" id="cantIn" value="1">
            <label>Observaciones:</label>
            <textarea id="obsIn" rows="2" placeholder="Ej: Vencimiento, estado..."></textarea>
            <button class="btn btn-main" onclick="enviarIngreso()">Confirmar Primicia</button>
            <button class="btn btn-outline" onclick="irA('ingresoCat')">Cambiar Categor√≠a</button>
        </div>
    </div>

    <div id="salidaPersona" class="hidden">
        <div class="form-group">
            <h3>Identificaci√≥n del Receptor</h3>
            <label>N√∫mero de C√©dula:</label>
            <input type="number" id="ccOut" placeholder="Ingrese CC">
            <button class="btn btn-main" onclick="buscarCC()">Verificar Datos</button>
            
            <div id="extraSalida" class="hidden">
                <div id="infoExistente" style="background:#f0fdf4; padding:10px; border-radius:10px; margin-bottom:15px; font-size:14px;"></div>
                <div id="formNuevo" class="hidden">
                    <label>Nombre del Receptor:</label>
                    <input type="text" id="nombreOut">
                    <label>Cargo / Rol:</label>
                    <select id="rolOut">
                        <option value="Colaborador">Colaborador</option>
                        <option value="Area">Area</option>
                        <option value="Sup General">Sup General</option>
                        <option value="Sup Auxiliar">Sup Auxiliar</option>
                        <option value="L√≠der">L√≠der</option>
                        <option value="Hermano mayor">Hermano mayor</option>
                        <option value="Coordinador El Camino">Coordinador El Camino</option>
                        <option value="Maestro">Maestro</option>
                        <option value="Diaconado">Diaconado</option>
                    </select>
                </div>
                <label>¬øQu√© se entrega?</label>
                <select id="catOut" onchange="actualizarProdsSalida()">
                    <option value="">-- Clasificaci√≥n --</option>
                    <option value="Alimentos">Alimentos</option>
                    <option value="Ropa y Textiles">Ropa y Textiles</option>
                    <option value="Medicamentos y Salud">Medicamentos y Salud</option>
                    <option value="Art√≠culos de Higiene">Higiene</option>
                    <option value="√ötiles Escolares">√ötiles</option>
                    <option value="Herramientas">Herramientas</option>
                    <option value="Tecnolog√≠a">Tecnolog√≠a</option>
                    <option value="Miscel√°neos/Otros">Otros</option>
                </select>
                <select id="prodOut"><option value="">-- Elegir producto --</option></select>
                <label>Cantidad:</label>
                <input type="number" id="cantOut" value="1">
                <button class="btn btn-success" onclick="enviarSalida()">Registrar Entrega</button>
            </div>
            <button class="btn btn-outline" onclick="irA('menuScreen')">Cancelar</button>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxayHseCRZ2NYM2mcU5zXwZaucSOfz4gDnBo9NPSJXVZKNRpZxw22aT1rogXx4t_f_V/exec"; 

    const CATALOGO = {
        "Alimentos": ["Comida no perecedera", "Bebidas", "Productos perecederos"],
        "Ropa y Textiles": ["Ropa adultos/j√≥venes", "Ropa ni√±os/beb√©s", "Mantas y cobijas", "Calzado"],
        "Medicamentos y Salud": ["Medicamentos venta libre", "Insumos m√©dicos"],
        "Art√≠culos de Higiene": ["Higiene personal", "Limpieza hogar"],
        "√ötiles Escolares": ["Mochilas", "Cuadernos/L√°pices", "Libros", "Material arte"],
        "Herramientas": ["Manuales", "El√©ctricas", "Construcci√≥n", "Repuestos"],
        "Tecnolog√≠a": ["Tel√©fonos/Tablets", "Cables/Cargadores", "Electrodom√©sticos"],
        "Miscel√°neos/Otros": ["Perfumer√≠a/Cremas", "Juguetes", "Varios"]
    };

    let sedeData = null;
    let catSeleccionada = "";
    let esPersonaNueva = false;

    window.onload = () => {
        const urlP = new URLSearchParams(window.location.search);
        const clave = urlP.get('clave');
        const storage = localStorage.getItem('primicias_sede');
        if(clave) validar(clave);
        else if(storage) { sedeData = JSON.parse(storage); iniciar(); }
        else { document.getElementById('loading').innerText = "‚ùå No hay sede detectada. Escanea el QR."; }
    };

    function validar(c) {
        fetch(`${SCRIPT_URL}?accion=validar&clave=${c}`)
        .then(r => r.json()).then(d => {
            if(d.status === "success") {
                sedeData = d;
                localStorage.setItem('primicias_sede', JSON.stringify(d));
                window.history.replaceState({}, '', window.location.pathname);
                iniciar();
            }
        });
    }

    function iniciar() {
        document.getElementById('nombreSede').innerText = `üìç ${sedeData.sede}`;
        irA('menuScreen');
    }

    function irA(id) {
        ['menuScreen', 'ingresoCat', 'ingresoDetalle', 'salidaPersona', 'loading'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function seleccionarCat(cat, emoji) {
        catSeleccionada = cat;
        document.getElementById('catElegida').innerText = `${emoji} ${cat}`;
        const pSel = document.getElementById('prodIn');
        pSel.innerHTML = "";
        CATALOGO[cat].forEach(p => pSel.innerHTML += `<option value="${p}">${p}</option>`);
        irA('ingresoDetalle');
    }

    function actualizarProdsSalida() {
        const cat = document.getElementById('catOut').value;
        const pSel = document.getElementById('prodOut');
        pSel.innerHTML = "";
        if(CATALOGO[cat]) CATALOGO[cat].forEach(p => pSel.innerHTML += `<option value="${p}">${p}</option>`);
    }

    function buscarCC() {
        const cc = document.getElementById('ccOut').value;
        fetch(`${SCRIPT_URL}?accion=buscar&cc=${cc}`)
        .then(r => r.json()).then(d => {
            document.getElementById('extraSalida').classList.remove('hidden');
            if(d.status === "success") {
                esPersonaNueva = false;
                document.getElementById('formNuevo').classList.add('hidden');
                document.getElementById('infoExistente').classList.remove('hidden');
                document.getElementById('infoExistente').innerHTML = `<b>${d.nombre}</b> (${d.rol})<br>√öltima entrega: ${d.ultimoProducto}`;
            } else {
                esPersonaNueva = true;
                document.getElementById('formNuevo').classList.remove('hidden');
                document.getElementById('infoExistente').classList.add('hidden');
            }
        });
    }

    function enviarIngreso() {
        const d = {
            tipo: 'ingreso', sede: sedeData.sede,
            categoria: catSeleccionada,
            producto: document.getElementById('prodIn').value,
            cantidad: document.getElementById('cantIn').value,
            observaciones: document.getElementById('obsIn').value
        };
        save(d);
    }

    function enviarSalida() {
        const d = {
            tipo: 'salida', sede: sedeData.sede,
            cc: document.getElementById('ccOut').value,
            categoria: document.getElementById('catOut').value,
            producto: document.getElementById('prodOut').value,
            cantidad: document.getElementById('cantOut').value,
            estado: "Entregado", observaciones: ""
        };
        if(esPersonaNueva) {
            d.nombre = document.getElementById('nombreOut').value;
            d.rol = document.getElementById('rolOut').value;
        }
        save(d);
    }

    function save(obj) {
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(obj) })
        .then(r => r.json()).then(res => { if(res.status === "success") { alert("‚úÖ Guardado"); location.reload(); } });
    }

    function cerrarSesion() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
