<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Primicias V4</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --primary: #4f46e5; --secondary: #10b981; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: 'Segoe UI', system-ui; background: var(--bg); margin: 0; padding: 0; }
        .header { background: white; padding: 15px; text-align: center; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 100; }
        .container { max-width: 500px; margin: auto; padding: 15px; }
        .hidden { display: none; }
        
        /* Botones de Categor√≠a Estilo App */
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn-card { 
            background: var(--card); border: 1px solid #e2e8f0; border-radius: 16px; 
            padding: 20px; text-align: center; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn-card:active { transform: scale(0.95); background: #f1f5f9; }
        .btn-card i { color: var(--primary); margin-bottom: 8px; }
        .btn-card span { font-weight: 600; font-size: 13px; color: #334155; }

        /* Formulario */
        .form-group { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px #0001; margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; }
        
        .btn-main { background: var(--primary); color: white; border: none; width: 100%; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .btn-back { background: #64748b; color: white; border: none; width: 100%; padding: 10px; border-radius: 12px; margin-top: 10px; cursor: pointer; }
        
        /* Toggle Mercado */
        .toggle-container { display: flex; align-items: center; justify-content: space-between; background: #ecfdf5; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #10b981; }
        
        .badge-sede { background: #e0e7ff; color: #4338ca; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

<div class="header">
    <div id="sedeDisplay"><span class="badge-sede">Cargando Sede...</span></div>
</div>

<div class="container">
    <div id="viewMain">
        <h2 style="text-align: center; color: #1e293b;">¬øQu√© deseas hacer?</h2>
        <div class="grid-menu">
            <div class="btn-card" onclick="showView('viewIngreso')">
                <i data-lucide="download" size="32"></i><span>RECIBIR</span>
            </div>
            <div class="btn-card" onclick="showView('viewSalida')">
                <i data-lucide="upload" size="32"></i><span>ENTREGAR</span>
            </div>
        </div>
    </div>

    <div id="viewIngreso" class="hidden">
        <h3>Selecciona Categor√≠a</h3>
        <div id="catGrid" class="grid-menu"></div>
        <button class="btn-back" onclick="showView('viewMain')">Volver</button>
    </div>

    <div id="viewSubCat" class="hidden">
        <h3 id="subCatTitle"></h3>
        <div id="subCatGrid" class="grid-menu"></div>
        <button class="btn-back" onclick="showView('viewIngreso')">Atr√°s</button>
    </div>

    <div id="viewFinalIngreso" class="hidden">
        <div class="form-group">
            <h4 id="prodSelTitle" style="color: var(--primary);"></h4>
            <input type="text" id="customProd" class="hidden" placeholder="¬øCu√°l art√≠culo?">
            <label>Cantidad</label>
            <input type="number" id="cantIn" value="1">
            <label>Observaciones</label>
            <textarea id="obsIn" rows="3" placeholder="Ej: Buen estado, vence pronto..."></textarea>
            <button class="btn-main" onclick="saveIngreso()">GUARDAR ENTRADA</button>
        </div>
    </div>

    <div id="viewSalida" class="hidden">
        <div class="form-group">
            <h3>Registro de Entrega</h3>
            <label>C√©dula</label>
            <input type="number" id="ccOut" placeholder="Sin puntos ni comas">
            <label>Nombre Completo</label>
            <input type="text" id="nomOut" placeholder="Nombre del beneficiario">
            <label>Cargo en la Visi√≥n</label>
            <select id="cargoOut">
                <option value="Colaborador">Colaborador</option>
                <option value="Sup General">Sup General</option>
                <option value="Sup Auxiliar">Sup Auxiliar</option>
                <option value="L√≠der">L√≠der</option>
                <option value="Hermano mayor">Hermano mayor</option>
                <option value="Coordinador El Camino">Coordinador El Camino</option>
                <option value="Maestro">Maestro</option>
                <option value="Diaconado">Diaconado</option>
                <option value="Otros">Otros</option>
            </select>

            <div class="toggle-container">
                <span style="font-weight: bold; color: #065f46;">¬øLLEVA MERCADO?</span>
                <input type="checkbox" id="checkMercado" style="width: 25px; height: 25px; margin: 0;">
            </div>

            <label>Otros art√≠culos (Opcional)</label>
            <select id="extraCatOut">
                <option value="Ninguno">-- Ninguno --</option>
                <option value="Alimentos">Alimentos (Extras)</option>
                <option value="Ropa y Textiles">Ropa y Textiles</option>
                <option value="Medicamentos">Medicamentos</option>
                <option value="Higiene">Higiene y Limpieza</option>
                <option value="√ötiles">√ötiles Escolares</option>
                <option value="Herramientas">Herramientas</option>
                <option value="Tecnolog√≠a">Tecnolog√≠a</option>
                <option value="Miscel√°neos">Miscel√°neos / Otros</option>
            </select>
            <input type="text" id="extraDetalle" placeholder="Detalle de lo que lleva (ej: 2 camisas)">

            <button class="btn-main" onclick="saveSalida()">FINALIZAR ENTREGA</button>
            <button class="btn-back" onclick="showView('viewMain')">Cancelar</button>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxFZfloXfxEg0tA5kzrET0k0oVRArsGjGupZUihs2eBDHBqncdJPKn9fWTzjrVlTR5L/exec";
    
    const DATA_MAP = {
        "Alimentos": { icon: "apple", items: ["Comida no perecedera", "Bebidas", "Productos perecederos", "Otro Alimento"] },
        "Ropa y Textiles": { icon: "shirt", items: ["Ropa adultos", "Ropa ni√±os/beb√©s", "Mantas y s√°banas", "Calzado y accesorios", "Otro Ropa"] },
        "Medicamentos": { icon: "pill", items: ["Venta libre (Analgesicos)", "Insumos m√©dicos", "Otro Salud"] },
        "Higiene": { icon: "droplets", items: ["Higiene personal", "Limpieza hogar", "Otro Limpieza"] },
        "√ötiles": { icon: "book-open", items: ["Mochilas y estuches", "Cuadernos y l√°pices", "Libros", "Material de arte", "Otro √ötiles"] },
        "Herramientas": { icon: "wrench", items: ["Manuales", "El√©ctricas peque√±as", "Clavos/Repuestos", "Construcci√≥n", "Otro Herramientas"] },
        "Tecnolog√≠a": { icon: "smartphone", items: ["Tel√©fonos/Tablets", "Accesorios (Cables)", "Peque√±os electrodom√©sticos", "Otro Tech"] },
        "Miscel√°neos": { icon: "package", items: ["Perfumes/Cremas", "Juguetes/Adornos", "Muebles peque√±os", "Otro Miscel√°neo"] }
    };

    let flow = { start: 0, sede: localStorage.getItem('p_sede') || "Sede General", cat: "", prod: "" };

    window.onload = () => {
        const urlP = new URLSearchParams(window.location.search);
        if(urlP.get('sede')) {
            flow.sede = urlP.get('sede');
            localStorage.setItem('p_sede', flow.sede);
        }
        document.getElementById('sedeDisplay').innerHTML = `<span class="badge-sede">üìç ${flow.sede}</span>`;
        initMenu();
        lucide.createIcons();
    };

    function initMenu() {
        const grid = document.getElementById('catGrid');
        for (const [key, val] of Object.entries(DATA_MAP)) {
            grid.innerHTML += `
                <div class="btn-card" onclick="selectCat('${key}')">
                    <i data-lucide="${val.icon}" size="28"></i><span>${key.toUpperCase()}</span>
                </div>`;
        }
    }

    function selectCat(cat) {
        flow.cat = cat;
        document.getElementById('subCatTitle').innerText = cat;
        const grid = document.getElementById('subCatGrid');
        grid.innerHTML = "";
        DATA_MAP[cat].items.forEach(item => {
            grid.innerHTML += `
                <div class="btn-card" onclick="selectProd('${item}')">
                    <i data-lucide="chevron-right" size="20"></i><span>${item}</span>
                </div>`;
        });
        showView('viewSubCat');
    }

    function selectProd(prod) {
        flow.prod = prod;
        document.getElementById('prodSelTitle').innerText = prod;
        document.getElementById('customProd').classList.toggle('hidden', !prod.includes("Otro"));
        showView('viewFinalIngreso');
    }

    function showView(id) {
        document.querySelectorAll('.container > div').forEach(v => v.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        lucide.createIcons();
    }

    function saveIngreso() {
        const btn = document.querySelector('#viewFinalIngreso .btn-main');
        btn.disabled = true; btn.innerText = "GUARDANDO...";
        
        const finalProd = flow.prod.includes("Otro") ? document.getElementById('customProd').value : flow.prod;
        
        const payload = {
            accion: "ingreso",
            sede: flow.sede,
            categoria: flow.cat,
            producto: finalProd,
            cantidad: document.getElementById('cantIn').value,
            obs: document.getElementById('obsIn').value
        };

        google.script.run.withSuccessHandler(() => {
            alert("Entrada registrada!");
            location.reload();
        }).processData(payload);
    }

    function saveSalida() {
        const btn = document.querySelector('#viewSalida .btn-main');
        if(!document.getElementById('nomOut').value) return alert("Falta nombre");
        
        btn.disabled = true; btn.innerText = "GUARDANDO...";
        
        const payload = {
            accion: "salida",
            sede: flow.sede,
            cc: document.getElementById('ccOut').value,
            nombre: document.getElementById('nomOut').value,
            cargo: document.getElementById('cargoOut').value,
            mercado: document.getElementById('checkMercado').checked ? "S√ç" : "NO",
            extraCat: document.getElementById('extraCatOut').value,
            extraDetalle: document.getElementById('extraDetalle').value
        };

        google.script.run.withSuccessHandler(() => {
            alert("Entrega registrada!");
            location.reload();
        }).processData(payload);
    }
</script>
</body>
</html>
