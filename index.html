<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primicias Pro v5</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4f46e5; --primary-light: #eef2ff;
            --accent: #10b981; --bg: #f4f7fa; --text: #0f172a; 
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 40px; }
        
        /* Loader Premium */
        #loader { 
            display:none; position:fixed; inset:0; background:rgba(255,255,255,0.9); 
            z-index:1000; flex-direction:column; align-items:center; justify-content:center; 
            backdrop-filter: blur(5px);
        }
        .spinner { width: 50px; height: 50px; border: 5px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .header { background: white; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); sticky; top:0; z-index: 100; }
        .badge-sede { background: var(--primary-light); color: var(--primary); padding: 6px 15px; border-radius: 20px; font-weight: 800; font-size: 12px; }
        
        .container { max-width: 480px; margin: auto; padding: 20px; }
        .hidden { display: none; }
        
        /* Tipograf√≠a */
        h2 { font-weight: 800; font-size: 24px; margin-bottom: 20px; letter-spacing: -0.5px; }
        h3 { font-weight: 700; font-size: 18px; margin-bottom: 15px; color: #475569; }

        /* Bot√≥n Volver */
        .btn-nav-back { 
            display: inline-flex; align-items: center; gap: 5px; color: #64748b; 
            font-weight: 700; font-size: 14px; cursor: pointer; margin-bottom: 15px;
        }

        /* Cards Grid */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { 
            background: white; border-radius: 24px; padding: 25px 15px; text-align: center; 
            border: 2px solid transparent; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer;
        }
        .card:active { transform: scale(0.95); }
        .card.selected { border-color: var(--accent); background: #f0fdf4; }
        .card i { color: var(--primary); margin-bottom: 12px; }
        .card.selected i { color: var(--accent); }
        .card span { font-size: 13px; font-weight: 700; display: block; line-height: 1.2; }

        /* Forms */
        .form-label { display: block; font-weight: 700; font-size: 14px; margin-bottom: 8px; color: #1e293b; }
        input, select, textarea { 
            width: 100%; padding: 16px; border-radius: 16px; border: 2px solid #e2e8f0; 
            background: white; font-size: 16px; margin-bottom: 15px; box-sizing: border-box; outline: none;
        }
        input:focus { border-color: var(--primary); }

        .btn-send { 
            background: var(--primary); color: white; border: none; width: 100%; 
            padding: 20px; border-radius: 18px; font-weight: 800; font-size: 16px; cursor: pointer;
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3); margin-top: 10px;
        }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p id="loaderText" style="font-weight: 800; margin-top: 20px;">Sincronizando...</p>
</div>

<div class="header">
    <span id="sedeLabel" class="badge-sede">CONECTANDO...</span>
</div>

<div class="container">
    <div id="viewMain" class="hidden">
        <h2>Panel de Control</h2>
        <div class="grid">
            <div class="card" onclick="showView('viewInCat')" style="grid-column: span 2; padding: 45px;">
                <i data-lucide="package-plus" size="40"></i><span>INGRESAR PRIMICIA</span>
            </div>
            <div class="card" onclick="showView('viewOut')" style="grid-column: span 2; padding: 45px;">
                <i data-lucide="hand-helping" size="40"></i><span>ENTREGAR AYUDA</span>
            </div>
        </div>
    </div>

    <div id="viewInCat" class="hidden">
        <div class="btn-nav-back" onclick="showView('viewMain')"><i data-lucide="chevron-left"></i> Men√∫ Principal</div>
        <h3>Seleccione Clasificaci√≥n</h3>
        <div id="gridInCat" class="grid"></div>
    </div>

    <div id="viewInProd" class="hidden">
        <div class="btn-nav-back" onclick="showView('viewInCat')"><i data-lucide="chevron-left"></i> Cambiar Clasificaci√≥n</div>
        <h3 id="labelCatIn" style="color:var(--primary);"></h3>
        <div id="gridInProd" class="grid"></div>
    </div>

    <div id="viewInFinal" class="hidden">
        <div class="btn-nav-back" onclick="showView('viewInProd')"><i data-lucide="chevron-left"></i> Cambiar Producto</div>
        <h3 id="labelProdIn"></h3>
        
        <div id="boxOtroIn" class="hidden">
            <span class="form-label">Especifique el producto:</span>
            <input type="text" id="otroInEspecifique" placeholder="¬øQu√© es exactamente?">
        </div>

        <span class="form-label">Cantidad:</span>
        <input type="number" id="cantIn" value="1">
        
        <span class="form-label">Observaciones:</span>
        <textarea id="obsIn" rows="3" placeholder="Estado, vencimiento, etc..."></textarea>
        
        <button class="btn-send" onclick="saveIngreso()">GUARDAR ENTRADA</button>
    </div>

    <div id="viewOut" class="hidden">
        <div class="btn-nav-back" onclick="showView('viewMain')"><i data-lucide="chevron-left"></i> Cancelar</div>
        <h3>Datos de Entrega</h3>
        <input type="number" id="ccOut" placeholder="C√©dula del beneficiario">
        <input type="text" id="nomOut" placeholder="Nombre completo">
        <select id="cargoOut">
            <option value="">Cargo en la Visi√≥n...</option>
            <option value="Colaborador">Colaborador</option>
            <option value="L√≠der">L√≠der</option>
            <option value="Maestro">Maestro</option>
            <option value="Diaconado">Diaconado</option>
            <option value="Sup General">Sup General</option>
            <option value="Sup Auxiliar">Sup Auxiliar</option>
            <option value="Hermano mayor">Hermano mayor</option>
            <option value="Coordinador El Camino">Coordinador El Camino</option>
            <option value="Otros">Otros</option>
        </select>

        <h3 style="margin-top:25px;">Seleccione los art√≠culos</h3>
        <div class="grid">
            <div class="card out-item" onclick="toggleSelect(this, 'MERCADO')" style="grid-column: span 2; background:#f0fdf4;">
                <i data-lucide="shopping-basket"></i><span>LLEVA MERCADO</span>
            </div>
            <div class="card out-item" onclick="toggleSelect(this, 'Alimentos')"><i data-lucide="apple"></i><span>ALIMENTOS</span></div>
            <div class="card out-item" onclick="toggleSelect(this, 'Ropa')"><i data-lucide="shirt"></i><span>ROPA</span></div>
            <div class="card out-item" onclick="toggleSelect(this, 'Higiene')"><i data-lucide="droplets"></i><span>HIGIENE</span></div>
            <div class="card out-item" onclick="toggleSelect(this, 'Salud')"><i data-lucide="pill"></i><span>SALUD</span></div>
            <div class="card out-item" onclick="toggleSelect(this, '√ötiles')"><i data-lucide="book-open"></i><span>√öTILES</span></div>
            <div class="card out-item" onclick="toggleSelect(this, 'Herramientas')"><i data-lucide="wrench"></i><span>HERR.</span></div>
            <div class="card out-item" onclick="toggleSelect(this, 'Tecnolog√≠a')"><i data-lucide="smartphone"></i><span>TECNO.</span></div>
        </div>

        <button class="btn-send" style="margin-top:30px;" onclick="saveSalida()">REGISTRAR ENTREGA</button>
    </div>
</div>

<script>
    const URL_GAS = "https://script.google.com/macros/s/AKfycbzjGitbrLRl-t4cX8Gsf9Chfw0ZDga7EIAng-WZvd1y9QnVuxEYDi_tBxQn9IBrUuYb/exec"; // RECUERDA PONER TU URL /exec
    
    const ESTRUCTURA = {
        "Alimentos": { icon: "apple", p: ["Comida no perecedera", "Bebidas", "Productos perecederos", "Otros Alimentos"] },
        "Ropa y Textiles": { icon: "shirt", p: ["Ropa adultos/j√≥venes", "Ropa ni√±os/beb√©s", "Mantas y s√°banas", "Calzado y accesorios", "Otros Ropa"] },
        "Medicamentos y Salud": { icon: "pill", p: ["Medicamentos venta libre", "Insumos m√©dicos", "Otros Salud"] },
        "Higiene y Limpieza": { icon: "droplets", p: ["Higiene personal", "Limpieza hogar", "Otros Aseo"] },
        "√ötiles Escolares": { icon: "book-open", p: ["Mochilas y estuches", "Cuadernos y l√°pices", "Libros", "Material de arte", "Otros √ötiles"] },
        "Herramientas": { icon: "wrench", p: ["Herramientas manuales", "El√©ctricas peque√±as", "Clavos y repuestos", "Construcci√≥n", "Otros Herramientas"] },
        "Tecnolog√≠a": { icon: "smartphone", p: ["Tel√©fonos/Tablets", "Accesorios", "Electrodom√©sticos peque√±os", "Otros Tech"] },
        "Miscel√°neos": { icon: "package", p: ["Accesorios (Perfumes/Cremas)", "Juguetes y adornos", "Otros Miscel√°neos"] }
    };

    let flow = { sede: localStorage.getItem('p_sede') || "", cat: "", prod: "", salidaArticulos: [] };

    window.onload = () => {
        const urlP = new URLSearchParams(window.location.search);
        const clave = urlP.get('clave');
        if (flow.sede) startApp();
        else if (clave) {
            fetch(`${URL_GAS}?clave=${clave}`).then(r => r.json()).then(d => {
                if(d.status === "success") { flow.sede = d.sede; localStorage.setItem('p_sede', d.sede); startApp(); }
            });
        }
    };

    function startApp() {
        document.getElementById('sedeLabel').innerText = "üìç " + flow.sede;
        const grid = document.getElementById('gridInCat');
        grid.innerHTML = "";
        for (const [key, val] of Object.entries(ESTRUCTURA)) {
            grid.innerHTML += `<div class="card" onclick="selInCat('${key}')"><i data-lucide="${val.icon}"></i><span>${key}</span></div>`;
        }
        showView('viewMain');
    }

    function selInCat(cat) {
        flow.cat = cat;
        document.getElementById('labelCatIn').innerText = cat;
        const grid = document.getElementById('gridInProd');
        grid.innerHTML = "";
        ESTRUCTURA[cat].p.forEach(p => {
            grid.innerHTML += `<div class="card" onclick="selInProd('${p}')"><i data-lucide="chevron-right"></i><span>${p}</span></div>`;
        });
        showView('viewInProd');
    }

    function selInProd(p) { 
        flow.prod = p; 
        document.getElementById('labelProdIn').innerText = p; 
        document.getElementById('boxOtroIn').className = p.includes("Otros") ? "visible" : "hidden";
        showView('viewInFinal'); 
    }

    function toggleSelect(el, item) {
        el.classList.toggle('selected');
        const index = flow.salidaArticulos.indexOf(item);
        if (index > -1) flow.salidaArticulos.splice(index, 1);
        else flow.salidaArticulos.push(item);
    }

    function showView(id) {
        document.querySelectorAll('.container > div').forEach(v => v.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        lucide.createIcons();
    }

    function send(data) {
        const loader = document.getElementById('loader');
        const text = document.getElementById('loaderText');
        loader.style.display = 'flex';
        text.innerHTML = "Enviando datos...";

        fetch(URL_GAS, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) })
        .then(() => {
            text.innerHTML = "‚úÖ ¬°Guardado con √©xito!";
            text.style.color = "#10b981";
            setTimeout(() => { location.reload(); }, 2000);
        });
    }

    function saveIngreso() {
        let pFinal = flow.prod;
        if(pFinal.includes("Otros")) pFinal = "OTRO: " + document.getElementById('otroInEspecifique').value;
        send({ 
            accion: "ingreso", sede: flow.sede, categoria: flow.cat, 
            producto: pFinal, cantidad: document.getElementById('cantIn').value, 
            obs: document.getElementById('obsIn').value 
        });
    }

    function saveSalida() {
        if(!document.getElementById('nomOut').value) return alert("Ingrese el nombre");
        const m = flow.salidaArticulos.includes('MERCADO') ? 'S√ç' : 'NO';
        const a = flow.salidaArticulos.filter(i => i !== 'MERCADO').join(', ');
        send({ 
            accion: "salida", sede: flow.sede, cc: document.getElementById('ccOut').value, 
            nombre: document.getElementById('nomOut').value, cargo: document.getElementById('cargoOut').value, 
            mercado: m, articulos: a 
        });
    }
</script>
</body>
</html>
