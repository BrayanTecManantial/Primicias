<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primicias App</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4f46e5; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; color: var(--text); }
        .header { background: white; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); sticky: top; }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; }
        .hidden { display: none; }
        
        /* Cuadr√≠cula T√°ctica */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .btn-card { 
            background: white; border-radius: 15px; padding: 20px; text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 2px solid transparent;
            transition: 0.2s; cursor: pointer; display: flex; flex-direction: column; align-items: center;
        }
        .btn-card:active { transform: scale(0.95); background: #eef2ff; }
        .btn-card.selected { border-color: var(--primary); background: #eef2ff; }
        .btn-card i { font-size: 32px; margin-bottom: 8px; font-style: normal; }
        .btn-card span { font-size: 13px; font-weight: 600; line-height: 1.2; }

        /* Formulario */
        .box { background: white; padding: 20px; border-radius: 15px; margin-top: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        input, select, textarea { 
            width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; 
            font-size: 16px; margin-bottom: 12px; box-sizing: border-box; font-family: inherit;
        }
        .btn-confirm { background: var(--primary); color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: 600; font-size: 16px; }
        .btn-back { background: #64748b; color: white; border: none; padding: 10px; width: 100%; border-radius: 10px; margin-top: 10px; }
        
        .badge { background: #e0e7ff; color: #4338ca; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .stepper { font-size: 12px; color: #64748b; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

<div class="header">
    <span id="sedeLabel" class="badge">Validando...</span>
    <h3 id="viewTitle" style="margin: 5px 0 0;">Primicias</h3>
</div>

<div class="container">
    <div id="loading" style="text-align:center; padding-top:50px;">‚è≥ Cargando configuraci√≥n...</div>

    <div id="menuView" class="hidden">
        <div class="grid">
            <div class="btn-card" onclick="showIngresoCat()" style="grid-column: span 2; padding: 40px;">
                <i>üéÅ</i><span>RECIBIR DONACI√ìN</span>
            </div>
            <div class="btn-card" onclick="showSalidaCC()" style="grid-column: span 2; padding: 40px;">
                <i>üôå</i><span>ENTREGAR AYUDA</span>
            </div>
        </div>
    </div>

    <div id="ingresoCatView" class="hidden">
        <span class="stepper">Paso 1 de 3</span>
        <h4>¬øQu√© tipo de donaci√≥n es?</h4>
        <div id="catGrid" class="grid"></div>
        <button class="btn-back" onclick="showView('menuView')">Volver al inicio</button>
    </div>

    <div id="ingresoProdView" class="hidden">
        <span class="stepper">Paso 2 de 3</span>
        <h4 id="selectedCatLabel"></h4>
        <div id="prodGrid" class="grid"></div>
        <button class="btn-back" onclick="showView('ingresoCatView')">Cambiar Categor√≠a</button>
    </div>

    <div id="ingresoFinalView" class="hidden">
        <span class="stepper">Paso 3 de 3</span>
        <div class="box">
            <h4 id="selectedProdLabel" style="margin-top:0;"></h4>
            <div id="customProdBox" class="hidden">
                <label style="font-size:12px;">Especificar Producto:</label>
                <input type="text" id="customProdName" placeholder="¬øQu√© es?">
            </div>
            <label style="font-size:12px;">Cantidad:</label>
            <input type="number" id="cantIn" value="1">
            <label style="font-size:12px;">Notas / Observaci√≥n:</label>
            <textarea id="obsIn" rows="2" placeholder="Opcional..."></textarea>
            <button class="btn-confirm" onclick="enviarIngreso()">Confirmar Ingreso</button>
        </div>
        <button class="btn-back" onclick="showView('ingresoProdView')">Atr√°s</button>
    </div>

    <div id="salidaCCView" class="hidden">
        <div class="box">
            <h4>Identificaci√≥n del Receptor</h4>
            <input type="number" id="ccIn" placeholder="C√©dula de Ciudadan√≠a">
            <button class="btn-confirm" onclick="validarReceptor()">Verificar</button>
        </div>
        <button class="btn-back" onclick="showView('menuView')">Cancelar</button>
    </div>

    <div id="salidaItemView" class="hidden">
        <div id="receptorInfo" class="box" style="background:#f0fdf4; margin-bottom:10px;"></div>
        
        <div id="nuevoReceptorBox" class="box hidden">
            <h4>Registro Nuevo</h4>
            <input type="text" id="nombreOut" placeholder="Nombre Completo">
            <select id="rolOut">
                <option value="Colaborador">Colaborador</option>
                <option value="L√≠der">L√≠der</option>
                <option value="Maestro">Maestro</option>
                <option value="Diaconado">Diaconado</option>
                <option value="Otro">Otro</option>
            </select>
        </div>

        <h4>¬øQu√© se entrega?</h4>
        <div class="grid">
            <div class="btn-card item-out" onclick="selOut(this, 'Mercado', 'üì¶')"><i>üì¶</i><span>MERCADO</span></div>
            <div class="btn-card item-out" onclick="selOut(this, 'Refrigerio', 'ü•™')"><i>ü•™</i><span>REFRIGERIO</span></div>
            <div class="btn-card item-out" onclick="selOut(this, 'Paquete Art√≠culos', 'üõçÔ∏è')"><i>üõçÔ∏è</i><span>PAQUETE</span></div>
        </div>
        
        <div class="box">
            <label style="font-size:12px;">Cantidad de Paquetes/Unidades:</label>
            <input type="number" id="cantOut" value="1">
            <button class="btn-confirm" onclick="enviarSalida()" style="background:#16a34a;">Confirmar Entrega</button>
        </div>
        <button class="btn-back" onclick="showView('salidaCCView')">Atr√°s</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxayHseCRZ2NYM2mcU5zXwZaucSOfz4gDnBo9NPSJXVZKNRpZxw22aT1rogXx4t_f_V/exec";

    const EMOJIS = { "Alimentos":"üçé","Ropa y Textiles":"üëï","Medicamentos y Salud":"üíä","Art√≠culos de Higiene":"üßº","√ötiles Escolares":"üìö","Herramientas":"üõ†Ô∏è","Tecnolog√≠a":"üíª","Miscel√°neos/Otros":"üì¶" };
    const DATA_INGRESOS = {
        "Alimentos": ["No perecedero", "Bebidas", "Perecederos", "Otro"],
        "Ropa y Textiles": ["Adulto", "Ni√±o/Beb√©", "Mantas", "Calzado", "Otro"],
        "Medicamentos y Salud": ["Venta libre", "Insumos", "Otro"],
        "Art√≠culos de Higiene": ["Personal", "Hogar", "Otro"],
        "√ötiles Escolares": ["Mochilas", "Cuadernos", "Arte", "Otro"],
        "Herramientas": ["Manual", "El√©ctrica", "Construcci√≥n", "Otro"],
        "Tecnolog√≠a": ["Cables/Cargadores", "Equipos", "Otro"],
        "Miscel√°neos/Otros": ["Perfumer√≠a", "Juguetes", "Muebles", "Otro"]
    };

    let state = { sede: "", cat: "", prod: "", outItem: "", isNew: false };

    window.onload = () => {
        const p = new URLSearchParams(window.location.search);
        const clave = p.get('clave') || localStorage.getItem('p_clave');
        if(clave) fetch(`${SCRIPT_URL}?accion=validar&clave=${clave}`).then(r=>r.json()).then(d=>{
            if(d.status==="success") { 
                state.sede = d.sede; 
                localStorage.setItem('p_clave', clave);
                document.getElementById('sedeLabel').innerText = "üìç " + d.sede;
                showView('menuView');
            }
        });
    };

    function showView(id) {
        document.querySelectorAll('.container > div').forEach(v => v.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    // FLUJO INGRESO
    function showIngresoCat() {
        const grid = document.getElementById('catGrid');
        grid.innerHTML = "";
        Object.keys(DATA_INGRESOS).forEach(c => {
            grid.innerHTML += `<div class="btn-card" onclick="selCat('${c}')"><i>${EMOJIS[c]}</i><span>${c}</span></div>`;
        });
        showView('ingresoCatView');
    }

    function selCat(c) {
        state.cat = c;
        document.getElementById('selectedCatLabel').innerText = EMOJIS[c] + " " + c;
        const grid = document.getElementById('prodGrid');
        grid.innerHTML = "";
        DATA_INGRESOS[c].forEach(p => {
            grid.innerHTML += `<div class="btn-card" onclick="selProd('${p}')"><i>üîπ</i><span>${p}</span></div>`;
        });
        showView('ingresoProdView');
    }

    function selProd(p) {
        state.prod = p;
        document.getElementById('selectedProdLabel').innerText = "Has elegido: " + p;
        document.getElementById('customProdBox').classList.toggle('hidden', p !== "Otro");
        showView('ingresoFinalView');
    }

    function enviarIngreso() {
        const finalProd = state.prod === "Otro" ? document.getElementById('customProdName').value : state.prod;
        const d = { tipo: 'ingreso', sede: state.sede, categoria: state.cat, producto: finalProd, cantidad: document.getElementById('cantIn').value, observaciones: document.getElementById('obsIn').value };
        post(d);
    }

    // FLUJO SALIDA
    function showSalidaCC() { showView('salidaCCView'); }

    function validarReceptor() {
        const cc = document.getElementById('ccIn').value;
        fetch(`${SCRIPT_URL}?accion=buscar&cc=${cc}`).then(r=>r.json()).then(d=>{
            showView('salidaItemView');
            if(d.status === "success") {
                state.isNew = false;
                document.getElementById('receptorInfo').classList.remove('hidden');
                document.getElementById('receptorInfo').innerHTML = `<b>${d.nombre}</b><br><small>${d.rol}</small>`;
                document.getElementById('nuevoReceptorBox').classList.add('hidden');
            } else {
                state.isNew = true;
                document.getElementById('receptorInfo').classList.add('hidden');
                document.getElementById('nuevoReceptorBox').classList.remove('hidden');
            }
        });
    }

    function selOut(el, item, emoji) {
        document.querySelectorAll('.item-out').forEach(b => b.classList.remove('selected'));
        el.classList.add('selected');
        state.outItem = item;
    }

    function enviarSalida() {
        if(!state.outItem) return alert("Selecciona qu√© entregas");
        const d = { 
            tipo: 'salida', sede: state.sede, cc: document.getElementById('ccIn').value, 
            categoria: "Ayuda Entregada", producto: state.outItem, 
            cantidad: document.getElementById('cantOut').value, estado: "Entregado" 
        };
        if(state.isNew) {
            d.nombre = document.getElementById('nombreOut').value;
            d.rol = document.getElementById('rolOut').value;
            if(!d.nombre) return alert("Escribe el nombre");
        }
        post(d);
    }

    function post(obj) {
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(obj) }).then(() => { alert("‚úÖ Registro Guardado"); location.reload(); });
    }

    function cerrarSesion() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
