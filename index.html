<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sede Primicias</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --card: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; }
        .header { background: white; padding: 15px; text-align: center; border-bottom: 2px solid #e2e8f0; }
        .container { max-width: 500px; margin: auto; padding: 15px; }
        .hidden { display: none; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { 
            background: var(--card); border-radius: 12px; padding: 20px; text-align: center; 
            box-shadow: 0 2px 4px #0001; cursor: pointer; border: 2px solid transparent;
        }
        .card:active { transform: scale(0.98); background: #f8fafc; }
        .card i { color: var(--primary); margin-bottom: 10px; }
        .card span { font-size: 13px; font-weight: bold; display: block; line-height: 1.2; }
        .form-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px #0001; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; }
        .btn-main { background: var(--primary); color: white; border: none; width: 100%; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-back { background: #64748b; color: white; border: none; width: 100%; padding: 10px; border-radius: 8px; margin-top: 10px; cursor: pointer; }
        .item-row { display: flex; align-items: center; justify-content: space-between; background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 5px; border: 1px solid #e2e8f0; }
    </style>
</head>
<body>

<div class="header">
    <span id="sedeLabel" style="background:#dbeafe; color:#1e40af; padding:5px 15px; border-radius:20px; font-weight:bold; font-size:12px;">Cargando...</span>
</div>

<div class="container">
    <div id="viewMain" class="hidden">
        <h2 style="text-align:center;">M√≥dulo Primicias</h2>
        <div class="grid">
            <div class="card" onclick="showView('viewIngresoCat')" style="grid-column: span 2; padding: 40px;">
                <i data-lucide="package-plus" size="32"></i><span>RECIBIR PRIMICIA</span>
            </div>
            <div class="card" onclick="showView('viewSalida')" style="grid-column: span 2; padding: 40px;">
                <i data-lucide="hand-helping" size="32"></i><span>ENTREGAR A PERSONA</span>
            </div>
        </div>
    </div>

    <div id="viewIngresoCat" class="hidden">
        <h3>¬øQu√© categor√≠a entra?</h3>
        <div id="gridCat" class="grid"></div>
        <button class="btn-back" onclick="showView('viewMain')">Volver</button>
    </div>

    <div id="viewIngresoProd" class="hidden">
        <h3 id="catTitle"></h3>
        <div id="gridProd" class="grid"></div>
        <button class="btn-back" onclick="showView('viewIngresoCat')">Atr√°s</button>
    </div>

    <div id="viewIngresoFinal" class="hidden">
        <div class="form-box">
            <h4 id="prodTitle" style="color:var(--primary);"></h4>
            <label>Cantidad:</label>
            <input type="number" id="cantIn" value="1">
            <label>Observaci√≥n (Opcional):</label>
            <textarea id="obsIn" placeholder="Ej: Vence pronto, caja da√±ada..."></textarea>
            <button class="btn-main" onclick="saveIngreso()">GUARDAR ENTRADA</button>
        </div>
    </div>

    <div id="viewSalida" class="hidden">
        <div class="form-box">
            <h3>Registro de Entrega</h3>
            <input type="number" id="ccOut" placeholder="C√©dula">
            <input type="text" id="nomOut" placeholder="Nombre completo">
            <select id="cargoOut">
                <option value="">-- Cargo en la Visi√≥n --</option>
                <option value="Colaborador">Colaborador</option>
                <option value="Area">Area</option>
                <option value="Sup General">Sup General</option>
                <option value="Sup Auxiliar">Sup Auxiliar</option>
                <option value="L√≠der">L√≠der</option>
                <option value="Hermano mayor">Hermano mayor</option>
                <option value="Coordinador El Camino">Coordinador El Camino</option>
                <option value="Maestro">Maestro</option>
                <option value="Diaconado">Diaconado</option>
                <option value="Otros">Otros</option>
            </select>

            <div class="item-row" style="background:#f0fdf4;">
                <b>¬øLLEVA MERCADO?</b>
                <input type="checkbox" id="checkMercado" style="width:20px; height:20px;">
            </div>

            <label>Art√≠culos Adicionales:</label>
            <textarea id="extrasOut" placeholder="Especifique qu√© otros art√≠culos lleva..."></textarea>
            
            <button class="btn-main" onclick="saveSalida()">REGISTRAR ENTREGA</button>
            <button class="btn-back" onclick="showView('viewMain')">Cancelar</button>
        </div>
    </div>
</div>

<script>
    const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbwoqOCXZFd6rw82Hb8nA4RJFc21BKhfsjWqLfzdWQPkSLp7G84Cniao6EByabZhma-n/exec";

    const ESTRUCTURA = {
        "Alimentos": { icon: "apple", prods: ["Comida no perecedera", "Bebidas", "Perecederos", "Otros Alimentos"] },
        "Ropa y Textiles": { icon: "shirt", prods: ["Ropa Adulto/Joven", "Ropa Ni√±os/Beb√©", "Mantas/S√°banas", "Calzado/Accesorios"] },
        "Medicamentos y Salud": { icon: "pill", prods: ["Venta libre", "Insumos m√©dicos", "Otros Salud"] },
        "Higiene y Limpieza": { icon: "droplets", prods: ["Higiene Personal", "Limpieza Hogar", "Otros Aseo"] },
        "√ötiles Escolares": { icon: "book-open", prods: ["Mochilas/Estuches", "Cuadernos/L√°pices", "Libros", "Material Arte"] },
        "Herramientas": { icon: "wrench", prods: ["Manuales", "El√©ctricas peque√±as", "Clavos/Cintas/Piezas", "Construcci√≥n"] },
        "Tecnolog√≠a": { icon: "smartphone", prods: ["Tel√©fonos/Tablets/Laptops", "Accesorios", "Peque√±os Electrodom√©sticos"] },
        "Miscel√°neos/Otros": { icon: "package", prods: ["Accesorios (Perfumes/Cremas)", "Juguetes/Adornos/Muebles"] }
    };

    let flow = { sede: localStorage.getItem('p_sede') || "", cat: "", prod: "" };

    window.onload = () => {
        const urlP = new URLSearchParams(window.location.search);
        const clave = urlP.get('clave');

        if (flow.sede) {
            startApp();
        } else if (clave) {
            fetch(`${GOOGLE_URL}?clave=${clave}`).then(r => r.json()).then(d => {
                if(d.status === "success") {
                    flow.sede = d.sede;
                    localStorage.setItem('p_sede', d.sede);
                    startApp();
                } else { alert("Acceso inv√°lido"); }
            });
        } else {
            document.getElementById('sedeLabel').innerText = "Acceso Denegado";
        }
    };

    function startApp() {
        document.getElementById('sedeLabel').innerText = "üìç " + flow.sede;
        const grid = document.getElementById('gridCat');
        for (const [key, val] of Object.entries(ESTRUCTURA)) {
            grid.innerHTML += `<div class="card" onclick="selCat('${key}')"><i data-lucide="${val.icon}"></i><span>${key}</span></div>`;
        }
        showView('viewMain');
    }

    function selCat(cat) {
        flow.cat = cat;
        document.getElementById('catTitle').innerText = cat;
        const grid = document.getElementById('gridProd');
        grid.innerHTML = "";
        ESTRUCTURA[cat].prods.forEach(p => {
            grid.innerHTML += `<div class="card" onclick="selProd('${p}')"><i data-lucide="chevron-right"></i><span>${p}</span></div>`;
        });
        showView('viewIngresoProd');
    }

    function selProd(p) {
        flow.prod = p;
        document.getElementById('prodTitle').innerText = p;
        showView('viewIngresoFinal');
    }

    function showView(id) {
        document.querySelectorAll('.container > div').forEach(v => v.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        lucide.createIcons();
    }

    function saveIngreso() {
        sendData({
            accion: "ingreso", sede: flow.sede, categoria: flow.cat, 
            producto: flow.prod, cantidad: document.getElementById('cantIn').value,
            obs: document.getElementById('obsIn').value
        });
    }

    function saveSalida() {
        if(!document.getElementById('nomOut').value) return alert("Ingrese Nombre");
        sendData({
            accion: "salida", sede: flow.sede, cc: document.getElementById('ccOut').value,
            nombre: document.getElementById('nomOut').value, cargo: document.getElementById('cargoOut').value,
            mercado: document.getElementById('checkMercado').checked ? "S√ç" : "NO",
            articulosExtra: document.getElementById('extrasOut').value
        });
    }

    function sendData(data) {
        fetch(GOOGLE_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) })
        .then(() => { alert("Guardado con √©xito"); location.reload(); });
    }
</script>
</body>
</html>
