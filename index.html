<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primicias Pro V4</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --primary: #4f46e5; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        .header { background: white; padding: 15px; text-align: center; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 100; }
        .container { max-width: 500px; margin: auto; padding: 15px; }
        .hidden { display: none; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .card { background: white; border-radius: 16px; padding: 20px; text-align: center; box-shadow: 0 4px 6px -1px #0001; cursor: pointer; border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; }
        .card:active { transform: scale(0.95); }
        .card.active { border-color: var(--primary); background: #f0f4ff; }
        .card i { color: var(--primary); margin-bottom: 8px; }
        .card span { font-size: 12px; font-weight: 600; }
        .form-box { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px #0001; margin-top: 15px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 12px; font-size: 16px; box-sizing: border-box; }
        .btn-main { background: var(--primary); color: white; border: none; width: 100%; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .btn-back { background: transparent; color: #64748b; border: none; width: 100%; padding: 10px; cursor: pointer; font-size: 14px; }
        .badge { background: #e0e7ff; color: #4338ca; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 12px; }
    </style>
</head>
<body>

<div class="header">
    <div id="sedeDisplay"><span class="badge">Validando Acceso...</span></div>
</div>

<div class="container">
    <div id="viewMain" class="hidden">
        <h2 style="text-align: center;">Gesti√≥n de Primicias</h2>
        <div class="grid">
            <div class="card" onclick="showView('viewIngresoCat')" style="grid-column: span 2; padding: 35px;">
                <i data-lucide="package-plus" size="40"></i><span>RECIBIR PRIMICIA</span>
            </div>
            <div class="card" onclick="showView('viewSalida')" style="grid-column: span 2; padding: 35px;">
                <i data-lucide="hand-helping" size="40"></i><span>ENTREGAR BENEFICIARIO</span>
            </div>
        </div>
    </div>

    <div id="viewIngresoCat" class="hidden">
        <h3>Clasificaci√≥n</h3>
        <div id="gridCat" class="grid"></div>
        <button class="btn-back" onclick="showView('viewMain')">Volver</button>
    </div>

    <div id="viewIngresoProd" class="hidden">
        <h3 id="labelCat"></h3>
        <div id="gridProd" class="grid"></div>
        <button class="btn-back" onclick="showView('viewIngresoCat')">Atr√°s</button>
    </div>

    <div id="viewIngresoFinal" class="hidden">
        <div class="form-box">
            <h4 id="labelProdFinal" style="color:var(--primary); margin-top:0;"></h4>
            <input type="number" id="cantIn" value="1" placeholder="Cantidad">
            <textarea id="obsIn" placeholder="Observaciones del estado..."></textarea>
            <button class="btn-main" onclick="saveIngreso()">GUARDAR ENTRADA</button>
        </div>
    </div>

    <div id="viewSalida" class="hidden">
        <div class="form-box">
            <h3>Datos de Entrega</h3>
            <input type="number" id="ccOut" placeholder="C√©dula">
            <input type="text" id="nomOut" placeholder="Nombre completo">
            <select id="cargoOut">
                <option value="Colaborador">Colaborador</option>
                <option value="Sup General">Sup General</option>
                <option value="Sup Auxiliar">Sup Auxiliar</option>
                <option value="L√≠der">L√≠der</option>
                <option value="Hermano mayor">Hermano mayor</option>
                <option value="Coordinador El Camino">Coordinador El Camino</option>
                <option value="Maestro">Maestro</option>
                <option value="Diaconado">Diaconado</option>
                <option value="Otros">Otros</option>
            </select>
            <div style="background:#f0fdf4; padding:10px; border-radius:8px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold; font-size:14px;">¬øLLEVA MERCADO?</span>
                <input type="checkbox" id="mercadoCheck" style="width:20px; height:20px; margin:0;">
            </div>
            <label style="font-size:12px; font-weight:bold;">Art√≠culo Adicional</label>
            <select id="extraCat">
                <option value="Ninguno">Ninguno</option>
                <option value="Ropa">Ropa y Textiles</option>
                <option value="Salud">Medicamentos y Salud</option>
                <option value="Higiene">Higiene y Limpieza</option>
                <option value="Escolares">√ötiles Escolares</option>
                <option value="Herramientas">Herramientas</option>
                <option value="Tecnolog√≠a">Tecnolog√≠a</option>
                <option value="Miscel√°neos">Miscel√°neos</option>
            </select>
            <input type="text" id="extraDetalle" placeholder="Detalle (ej: 1 Cobija)">
            <button class="btn-main" onclick="saveSalida()">FINALIZAR ENTREGA</button>
            <button class="btn-back" onclick="showView('viewMain')">Cancelar</button>
        </div>
    </div>
</div>

<script>
    // CAMBIA ESTO POR TU URL DE GOOGLE APPS SCRIPT
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyTgBFlrslqVlcuCPfErFKwSQV8BZgBm0-30vAUZoCY-Zv6nuWesPWURFSOFS21W7J5/exec";

    const CATEGORIAS = {
        "Alimentos": { icon: "apple", prods: ["Comida no perecedera", "Bebidas", "Productos perecederos", "Otros Alimentos"] },
        "Ropa y Textiles": { icon: "shirt", prods: ["Ropa adultos", "Ropa ni√±os/beb√©s", "Mantas y s√°banas", "Calzado y accesorios"] },
        "Medicamentos": { icon: "pill", prods: ["Venta libre", "Insumos m√©dicos", "Otros Salud"] },
        "Higiene": { icon: "droplets", prods: ["Higiene personal", "Limpieza hogar"] },
        "√ötiles Escolares": { icon: "book-open", prods: ["Mochilas y estuches", "Cuadernos y l√°pices", "Libros", "Material de arte"] },
        "Herramientas": { icon: "wrench", prods: ["Manuales", "El√©ctricas peque√±as", "Clavos/Repuestos", "Construcci√≥n"] },
        "Tecnolog√≠a": { icon: "smartphone", prods: ["Tel√©fonos/Tablets", "Accesorios", "Electrodom√©sticos peque√±os"] },
        "Miscel√°neos": { icon: "package", prods: ["Perfumes/Cremas", "Juguetes/Adornos", "Otros"] }
    };

    let flow = { sede: localStorage.getItem('p_sede') || "", cat: "", prod: "" };

    window.onload = () => {
        const urlP = new URLSearchParams(window.location.search);
        const clave = urlP.get('clave');

        if (flow.sede) {
            initApp();
        } else if (clave) {
            fetch(`${WEB_APP_URL}?clave=${clave}`).then(r => r.json()).then(d => {
                if(d.status === "success") {
                    flow.sede = d.sede;
                    localStorage.setItem('p_sede', d.sede);
                    initApp();
                } else { alert("Clave inv√°lida"); }
            });
        } else {
            document.getElementById('sedeDisplay').innerHTML = "‚ùå Acceso Denegado";
        }
    };

    function initApp() {
        document.getElementById('sedeDisplay').innerHTML = `<span class="badge">üìç ${flow.sede}</span>`;
        const grid = document.getElementById('gridCat');
        for (const [key, val] of Object.entries(CATEGORIAS)) {
            grid.innerHTML += `<div class="card" onclick="selectCat('${key}')"><i data-lucide="${val.icon}"></i><span>${key}</span></div>`;
        }
        showView('viewMain');
    }

    function selectCat(cat) {
        flow.cat = cat;
        document.getElementById('labelCat').innerText = cat;
        const grid = document.getElementById('gridProd');
        grid.innerHTML = "";
        CATEGORIAS[cat].prods.forEach(p => {
            grid.innerHTML += `<div class="card" onclick="selectProd('${p}')"><i data-lucide="chevron-right"></i><span>${p}</span></div>`;
        });
        showView('viewIngresoProd');
    }

    function selectProd(p) {
        flow.prod = p;
        document.getElementById('labelProdFinal').innerText = p;
        showView('viewIngresoFinal');
    }

    function showView(id) {
        document.querySelectorAll('.container > div').forEach(v => v.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        lucide.createIcons();
    }

    function saveIngreso() {
        send({
            accion: "ingreso", sede: flow.sede, categoria: flow.cat, 
            producto: flow.prod, cantidad: document.getElementById('cantIn').value,
            obs: document.getElementById('obsIn').value
        });
    }

    function saveSalida() {
        send({
            accion: "salida", sede: flow.sede, cc: document.getElementById('ccOut').value,
            nombre: document.getElementById('nomOut').value, cargo: document.getElementById('cargoOut').value,
            mercado: document.getElementById('mercadoCheck').checked ? "S√ç" : "NO",
            extraCat: document.getElementById('extraCat').value, extraDetalle: document.getElementById('extraDetalle').value
        });
    }

    function send(data) {
        document.querySelectorAll('.btn-main').forEach(b => b.disabled = true);
        fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) })
        .then(() => { alert("‚úÖ Registro Exitoso"); location.reload(); });
    }
</script>
</body>
</html>
