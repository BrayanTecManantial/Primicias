<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primicias Pro</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --bg: #f3f4f6; --text: #1f2937; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        .header { background: white; padding: 15px; text-align: center; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 99; }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; }
        .hidden { display: none; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .card { background: white; border-radius: 16px; padding: 20px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 2px solid transparent; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .card.active { border-color: var(--primary); background: #eef2ff; }
        .card i { margin-bottom: 10px; color: var(--primary); }
        .box { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-top: 15px; }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid #d1d5db; border-radius: 12px; font-size: 16px; margin-bottom: 15px; box-sizing: border-box; }
        .btn-next { background: var(--primary); color: white; border: none; padding: 16px; width: 100%; border-radius: 12px; font-weight: 600; cursor: pointer; }
        .badge { background: #e0e7ff; color: #4338ca; padding: 6px 14px; border-radius: 99px; font-size: 12px; font-weight: 700; }
        .timer-dot { display: inline-block; width: 8px; height: 8px; background: #10b981; border-radius: 50%; margin-right: 5px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="header">
    <span id="sedeLabel" class="badge">Validando...</span>
    <div style="margin-top:5px; font-size:11px; color:#6b7280;"><span class="timer-dot"></span>Sistema Activo</div>
</div>

<div class="container">
    <div id="viewMenu" class="hidden">
        <h2 style="text-align:center;">GestiÃ³n Primicias</h2>
        <div class="grid">
            <div class="card" onclick="startFlow('ingresoCat')" style="grid-column: span 2; padding: 30px;">
                <i data-lucide="package-plus" size="40"></i><span>RECIBIR</span>
            </div>
            <div class="card" onclick="startFlow('salidaCC')" style="grid-column: span 2; padding: 30px;">
                <i data-lucide="hand-helping" size="40"></i><span>ENTREGAR</span>
            </div>
        </div>
    </div>

    <div id="viewIngresoCat" class="hidden">
        <h3>ClasificaciÃ³n</h3>
        <div id="gridIngresoCat" class="grid"></div>
        <button class="btn-next" style="background:#9ca3af; margin-top:15px;" onclick="showView('viewMenu')">Volver</button>
    </div>

    <div id="viewIngresoProd" class="hidden">
        <h3 id="labelCatSel"></h3>
        <div id="gridIngresoProd" class="grid"></div>
    </div>

    <div id="viewIngresoFinal" class="hidden">
        <div class="box">
            <h4 id="labelProdSel" style="color:var(--primary);"></h4>
            <input type="number" id="cantIn" placeholder="Cantidad" value="1">
            <textarea id="obsIn" placeholder="Observaciones (Estado, etc.)"></textarea>
            <button id="btnSaveIn" class="btn-next" onclick="saveIngreso()">Guardar Registro</button>
        </div>
    </div>

    <div id="viewSalidaCC" class="hidden">
        <div class="box">
            <h3>Datos del Beneficiario</h3>
            <input type="number" id="ccOut" placeholder="NÃºmero de CÃ©dula">
            <input type="text" id="nomOut" placeholder="Nombre Completo">
            <select id="rolOut">
                <option value="Colaborador">Colaborador</option>
                <option value="LÃ­der">LÃ­der</option>
                <option value="Diaconado">Diaconado</option>
                <option value="Maestro">Maestro</option>
                <option value="Externo">Externo / Otro</option>
            </select>
            <button class="btn-next" onclick="showView('viewSalidaTipo')">Siguiente</button>
        </div>
    </div>

    <div id="viewSalidaTipo" class="hidden">
        <h3>Â¿QuÃ© entregas?</h3>
        <div class="grid">
            <div class="card out-type" onclick="selOutType(this, 'Mercado')"><i data-lucide="shopping-basket"></i><span>MERCADO</span></div>
            <div class="card out-type" onclick="selOutType(this, 'Refrigerio')"><i data-lucide="coffee"></i><span>REFRIGERIO</span></div>
            <div class="card out-type" onclick="selOutType(this, 'Paquete')"><i data-lucide="package"></i><span>PAQUETE</span></div>
        </div>
        <div id="boxPaqueteCat" class="hidden">
            <p style="font-size:12px; font-weight:bold; margin-top:15px;">Tipo de Paquete:</p>
            <div id="gridPaqueteCat" class="grid"></div>
        </div>
        <div class="box">
            <input type="number" id="cantOut" value="1">
            <button id="btnSaveOut" class="btn-next" onclick="saveSalida()">Finalizar</button>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw2tzG-r1eKGafY6KCGW6PNlsos89nrUdoWyYJQo_yZUVFnFqyJ76TpyCilXmGoAiVH/exec";

    // CLASIFICACIONES CERRADAS PARA ALIMENTOS
    const CATS = [
        {id: "Alimentos", icon: "apple", label: "Alimentos"},
        {id: "Aseo", icon: "bath", label: "Aseo / Higiene"},
        {id: "Ropa", icon: "shirt", label: "Ropa / Calzado"},
        {id: "Otros", icon: "box", label: "Otros"}
    ];

    const PRODS = {
        "Alimentos": ["Granos / Secos", "ProteÃ­nas (Enlatados)", "Aceites / Grasas", "LÃ¡cteos / Bebidas", "Harinas / PanaderÃ­a", "Frutas / Verduras"],
        "Aseo": ["Personal (JabÃ³n, Crema)", "Hogar (Detergente)", "PaÃ±ales / Otros"],
        "Ropa": ["Adulto", "NiÃ±o / BebÃ©", "Calzado"],
        "Otros": ["Ãštiles Escolares", "TecnologÃ­a", "Herramientas", "Juguetes"]
    };

    let flow = { start: 0, sede: localStorage.getItem('p_sede') || "", cat: "", prod: "", outType: "", outPaqCat: "" };

    window.onload = () => {
        const urlP = new URLSearchParams(window.location.search);
        const clave = urlP.get('clave') || localStorage.getItem('p_clave');
        if (clave) validarAcceso(clave);
        renderGrids();
    };

    function validarAcceso(c) {
        fetch(`${SCRIPT_URL}?accion=validar&clave=${c}`)
        .then(r => r.json()).then(d => {
            if(d.status === "success") {
                flow.sede = d.sede;
                localStorage.setItem('p_clave', c);
                localStorage.setItem('p_sede', d.sede);
                document.getElementById('sedeLabel').innerText = "ðŸ“ " + d.sede;
                showView('viewMenu');
            }
        });
    }

    function renderGrids() {
        const gIn = document.getElementById('gridIngresoCat');
        const gPaq = document.getElementById('gridPaqueteCat');
        CATS.forEach(c => {
            gIn.innerHTML += `<div class="card" onclick="selCat('${c.id}')"><i data-lucide="${c.icon}"></i><span>${c.label}</span></div>`;
            gPaq.innerHTML += `<div class="card paq-cat" onclick="selPaqCat(this, '${c.id}')"><i data-lucide="${c.icon}"></i><span>${c.label}</span></div>`;
        });
        lucide.createIcons();
    }

    function showView(id) {
        document.querySelectorAll('.container > div').forEach(v => v.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        lucide.createIcons();
    }

    function startFlow(viewId) {
        flow.start = Date.now();
        showView('view' + viewId.charAt(0).toUpperCase() + viewId.slice(1));
    }

    function selCat(id) {
        flow.cat = id;
        document.getElementById('labelCatSel').innerText = id;
        const gProd = document.getElementById('gridIngresoProd');
        gProd.innerHTML = "";
        PRODS[id].forEach(p => {
            gProd.innerHTML += `<div class="card" onclick="selProd('${p}')"><i data-lucide="chevron-right"></i><span>${p}</span></div>`;
        });
        showView('viewIngresoProd');
    }

    function selProd(p) {
        flow.prod = p;
        document.getElementById('labelProdSel').innerText = p;
        showView('viewIngresoFinal');
    }

    function selOutType(el, type) {
        document.querySelectorAll('.out-type').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        flow.outType = type;
        document.getElementById('boxPaqueteCat').classList.toggle('hidden', type !== 'Paquete');
    }

    function selPaqCat(el, cat) {
        document.querySelectorAll('.paq-cat').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        flow.outPaqCat = cat;
    }

    function saveIngreso() {
        const btn = document.getElementById('btnSaveIn');
        btn.disabled = true;
        const duracion = Math.round((Date.now() - flow.start) / 1000);
        post({
            tipo: 'ingreso', sede: flow.sede, categoria: flow.cat, 
            producto: flow.prod, cantidad: document.getElementById('cantIn').value,
            observaciones: document.getElementById('obsIn').value, duracion: duracion
        });
    }

    function saveSalida() {
        const btn = document.getElementById('btnSaveOut');
        btn.disabled = true;
        const duracion = Math.round((Date.now() - flow.start) / 1000);
        post({
            tipo: 'salida', sede: flow.sede, cc: document.getElementById('ccOut').value,
            nombre: document.getElementById('nomOut').value, rol: document.getElementById('rolOut').value,
            categoria: flow.outType, 
            producto: flow.outType === 'Paquete' ? "Paquete de " + flow.outPaqCat : flow.outType,
            cantidad: document.getElementById('cantOut').value, duracion: duracion
        });
    }

    function post(obj) {
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(obj) })
        .then(() => { alert("âœ… Guardado"); location.reload(); })
        .catch(() => { alert("Error"); location.reload(); });
    }
</script>
</body>
</html>
