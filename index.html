<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primicias Premium</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4f46e5; --accent: #10b981; --bg: #f8fafc; --text: #0f172a; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        
        /* Loading Overlay */
        #loader { display:none; position:fixed; inset:0; background:rgba(255,255,255,0.9); z-index:1000; flex-direction:column; align-items:center; justify-content:center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .header { background: white; padding: 20px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); sticky; top:0; }
        .container { max-width: 450px; margin: auto; padding: 20px; }
        .hidden { display: none; }
        
        /* Cards */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { 
            background: white; border-radius: 20px; padding: 20px; text-align: center; 
            border: 2px solid transparent; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            transition: all 0.2s; cursor: pointer;
        }
        .card:active { transform: scale(0.95); }
        .card.selected { border-color: var(--accent); background: #f0fdf4; }
        .card i { color: var(--primary); margin-bottom: 10px; }
        .card.selected i { color: var(--accent); }
        .card span { font-size: 13px; font-weight: 700; display: block; }

        /* Forms */
        input, select, textarea { 
            width: 100%; padding: 16px; border-radius: 14px; border: 1px solid #e2e8f0; 
            background: white; font-size: 16px; margin-bottom: 12px; box-sizing: border-box;
        }
        .btn-send { 
            background: var(--primary); color: white; border: none; width: 100%; 
            padding: 18px; border-radius: 16px; font-weight: 800; cursor: pointer;
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
        }
        .section-title { font-weight: 800; font-size: 1.2rem; margin-bottom: 20px; color: #1e293b; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p style="font-weight: 700; margin-top: 15px;">Guardando en la Nube...</p>
</div>

<div class="header">
    <span id="sedeLabel" style="background:#f1f5f9; padding:8px 16px; border-radius:12px; font-weight:800; color:var(--primary);">Verificando...</span>
</div>

<div class="container">
    <div id="viewMain" class="hidden">
        <h2 class="section-title">Panel de Control</h2>
        <div class="grid">
            <div class="card" onclick="showView('viewInCat')" style="grid-column: span 2; padding: 40px;">
                <i data-lucide="arrow-down-to-line" size="40"></i><span>INGRESAR PRIMICIA</span>
            </div>
            <div class="card" onclick="showView('viewOut')" style="grid-column: span 2; padding: 40px;">
                <i data-lucide="shopping-cart" size="40"></i><span>ENTREGAR AYUDA</span>
            </div>
        </div>
    </div>

    <div id="viewInCat" class="hidden">
        <h3 class="section-title">Clasificaci√≥n</h3>
        <div id="gridInCat" class="grid"></div>
        <button onclick="showView('viewMain')" style="background:none; border:none; width:100%; margin-top:20px; color:#64748b; font-weight:bold;">‚Üê Volver</button>
    </div>

    <div id="viewInProd" class="hidden">
        <h3 id="labelCatIn" class="section-title"></h3>
        <div id="gridInProd" class="grid"></div>
    </div>

    <div id="viewInFinal" class="hidden">
        <h3 id="labelProdIn" style="color:var(--primary);"></h3>
        <input type="number" id="cantIn" value="1">
        <textarea id="obsIn" placeholder="Observaciones adicionales..."></textarea>
        <button class="btn-send" onclick="saveIngreso()">REGISTRAR ENTRADA</button>
    </div>

    <div id="viewOut" class="hidden">
        <h3 class="section-title">Datos del Beneficiario</h3>
        <input type="number" id="ccOut" placeholder="C√©dula">
        <input type="text" id="nomOut" placeholder="Nombre completo">
        <select id="cargoOut">
            <option value="">Cargo...</option>
            <option value="Colaborador">Colaborador</option>
            <option value="L√≠der">L√≠der</option>
            <option value="Diaconado">Diaconado</option>
            <option value="Maestro">Maestro</option>
            <option value="Sup General">Sup General</option>
            <option value="Otros">Otros</option>
        </select>

        <h3 class="section-title" style="margin-top:30px;">¬øQu√© se entrega?</h3>
        <div class="grid">
            <div class="card out-item" onclick="toggleSelect(this, 'MERCADO')" style="grid-column: span 2; background:#f0fdf4;">
                <i data-lucide="shopping-basket"></i><span>LLEVA MERCADO</span>
            </div>
            <div class="card out-item" onclick="toggleSelect(this, 'Ropa')"><i data-lucide="shirt"></i><span>ROPA</span></div>
            <div class="card out-item" onclick="toggleSelect(this, 'Salud')"><i data-lucide="pill"></i><span>SALUD</span></div>
            <div class="card out-item" onclick="toggleSelect(this, 'Higiene')"><i data-lucide="droplets"></i><span>HIGIENE</span></div>
            <div class="card out-item" onclick="toggleSelect(this, '√ötiles')"><i data-lucide="book-open"></i><span>√öTILES</span></div>
            <div class="card out-item" onclick="toggleSelect(this, 'Herramientas')"><i data-lucide="wrench"></i><span>HERRAMIENTAS</span></div>
            <div class="card out-item" onclick="toggleSelect(this, 'Tecno')"><i data-lucide="smartphone"></i><span>TECNO</span></div>
        </div>

        <button class="btn-send" style="margin-top:30px;" onclick="saveSalida()">FINALIZAR Y GUARDAR</button>
    </div>
</div>

<script>
    const URL_GAS = "https://script.google.com/macros/s/AKfycbzjGitbrLRl-t4cX8Gsf9Chfw0ZDga7EIAng-WZvd1y9QnVuxEYDi_tBxQn9IBrUuYb/exec";
    const ESTRUCTURA = {
        "Alimentos": { icon: "apple", p: ["Comida no perecedera", "Bebidas", "Perecederos"] },
        "Ropa y Textiles": { icon: "shirt", p: ["Adulto", "Ni√±os", "Mantas/S√°banas", "Calzado"] },
        "Medicamentos y Salud": { icon: "pill", p: ["Venta libre", "Insumos m√©dicos"] },
        "Higiene y Limpieza": { icon: "droplets", p: ["Higiene Personal", "Limpieza Hogar"] },
        "√ötiles Escolares": { icon: "book-open", p: ["Mochilas", "Cuadernos/L√°pices", "Libros", "Arte"] },
        "Herramientas": { icon: "wrench", p: ["Manuales", "El√©ctricas", "Construcci√≥n"] },
        "Tecnolog√≠a": { icon: "smartphone", p: ["Tel√©fonos/Tablets", "Accesorios", "Peque√±os Electro"] },
        "Miscel√°neos": { icon: "package", p: ["Accesorios/Cremas", "Juguetes/Otros"] }
    };

    let flow = { sede: localStorage.getItem('p_sede') || "", cat: "", prod: "", salidaArticulos: [] };

    window.onload = () => {
        const urlP = new URLSearchParams(window.location.search);
        const clave = urlP.get('clave');
        if (flow.sede) startApp();
        else if (clave) {
            fetch(`${URL_GAS}?clave=${clave}`).then(r => r.json()).then(d => {
                if(d.status === "success") { flow.sede = d.sede; localStorage.setItem('p_sede', d.sede); startApp(); }
            });
        }
    };

    function startApp() {
        document.getElementById('sedeLabel').innerText = "üìç " + flow.sede;
        const grid = document.getElementById('gridInCat');
        for (const [key, val] of Object.entries(ESTRUCTURA)) {
            grid.innerHTML += `<div class="card" onclick="selInCat('${key}')"><i data-lucide="${val.icon}"></i><span>${key}</span></div>`;
        }
        showView('viewMain');
    }

    function selInCat(cat) {
        flow.cat = cat;
        document.getElementById('labelCatIn').innerText = cat;
        const grid = document.getElementById('gridInProd');
        grid.innerHTML = "";
        ESTRUCTURA[cat].p.forEach(p => {
            grid.innerHTML += `<div class="card" onclick="selInProd('${p}')"><i data-lucide="chevron-right"></i><span>${p}</span></div>`;
        });
        showView('viewInProd');
    }

    function selInProd(p) { flow.prod = p; document.getElementById('labelProdIn').innerText = p; showView('viewInFinal'); }

    function toggleSelect(el, item) {
        el.classList.toggle('selected');
        const index = flow.salidaArticulos.indexOf(item);
        if (index > -1) flow.salidaArticulos.splice(index, 1);
        else flow.salidaArticulos.push(item);
    }

    function showView(id) {
        document.querySelectorAll('.container > div').forEach(v => v.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        lucide.createIcons();
    }

    // REEMPLAZA SOLO LA FUNCI√ìN SEND Y SAVE EN TU SCRIPT DE GITHUB

function saveIngreso() {
    const data = { 
        accion: "ingreso", 
        sede: flow.sede, 
        categoria: flow.cat, 
        producto: flow.prod, 
        cantidad: document.getElementById('cantIn').value, 
        obs: document.getElementById('obsIn').value 
    };
    send(data);
}

function saveSalida() {
    if(!document.getElementById('nomOut').value || !document.getElementById('ccOut').value) {
        alert("Por favor completa Nombre y C√©dula");
        return;
    }
    const mercado = flow.salidaArticulos.includes('MERCADO') ? 'S√ç' : 'NO';
    const otros = flow.salidaArticulos.filter(i => i !== 'MERCADO').join(', ');
    
    const data = { 
        accion: "salida", 
        sede: flow.sede, 
        cc: document.getElementById('ccOut').value, 
        nombre: document.getElementById('nomOut').value, 
        cargo: document.getElementById('cargoOut').value, 
        mercado: mercado, 
        articulos: otros 
    };
    send(data);
}

function send(data) {
    const loader = document.getElementById('loader');
    const loaderText = loader.querySelector('p');
    
    // 1. Mostrar estado de carga
    loader.style.display = 'flex';
    loaderText.innerText = "Enviando a la nube...";
    loaderText.style.color = "#0f172a";

    fetch(URL_GAS, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) })
    .then(() => {
        // 2. Mostrar √©xito visualmente sin ventana emergente
        loader.querySelector('.spinner').style.display = 'none'; // Escondemos el c√≠rculo
        loaderText.innerHTML = "‚úÖ <br> ¬°Guardado con √©xito!";
        loaderText.style.color = "#10b981";
        loaderText.style.fontSize = "20px";

        // 3. Esperar 2 segundos y resetear la App al men√∫ inicial
        setTimeout(() => {
            resetFormularios();
            showView('viewMain');
            
            // Restaurar el loader para la pr√≥xima vez
            loader.style.display = 'none';
            loader.querySelector('.spinner').style.display = 'block';
            loaderText.style.fontSize = "16px";
        }, 2000);
    })
    .catch(err => {
        alert("Error de conexi√≥n. Intente de nuevo.");
        loader.style.display = 'none';
    });
}

function resetFormularios() {
    // Limpiar campos de texto
    document.querySelectorAll('input, textarea, select').forEach(el => el.value = (el.type === 'number' ? '1' : ''));
    // Limpiar selecci√≥n de salida
    flow.salidaArticulos = [];
    document.querySelectorAll('.out-item').forEach(el => el.classList.remove('selected'));
    // Resetear variables de flujo
    flow.cat = "";
    flow.prod = "";
}
</script>
</body>
</html>
